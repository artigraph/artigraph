#!/usr/bin/env python3

import shutil
from pathlib import Path

import typer
from sh import ErrorReturnCode_128, direnv, git

REPO_ROOT = Path(git("rev-parse", "--show-toplevel").stdout.decode().strip())

app = typer.Typer(name="dev")
worktree = typer.Typer(name="worktree")
app.add_typer(worktree)


@worktree.command("add")
def worktree_add(branch: str):
    try:
        git("show-ref", "--verify", f"refs/heads/{branch}")
    except ErrorReturnCode_128:
        typer.secho(f"Creating a new branch from origin/{branch}", fg="red")
        git.branch(branch, f"origin/{branch}")
    git.worktree.add(branch)
    branch_dir = Path(branch)
    if (envrc_secrets := REPO_ROOT / ".envrc.secrets").exists():
        (branch_dir / ".envrc.secrets").symlink_to(envrc_secrets)
    # Isolate venvs - slower but safer and prevents back and forth syncing
    shutil.rmtree(branch_dir / ".direnv/")
    shutil.copytree(REPO_ROOT / ".direnv", branch_dir / ".direnv/")
    direnv.allow(branch)
    typer.echo(f"Worktree '{branch}' created - clean up with: git worktree remove '{branch}'")


if __name__ == "__main__":
    app()
